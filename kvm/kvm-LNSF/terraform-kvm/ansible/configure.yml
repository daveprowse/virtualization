---
- name: Configure Desktop VMs with GNOME settings
  hosts: desktops
  become: yes
  tasks:
    - name: Wait for cloud-init to finish
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 600

    - name: Ensure display manager is running
      systemd:
        name: gdm
        state: started
        enabled: yes
      when: ansible_distribution in ["Debian", "Fedora"]

    - name: Set display resolution to 1920x1080
      become_user: user
      shell: |
        export DISPLAY=:0
        export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u user)/bus
        xrandr --output Virtual-0 --mode 1920x1080 || true
      ignore_errors: yes

- name: Verify server configurations
  hosts: servers
  become: yes
  tasks:
    - name: Wait for cloud-init to finish
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 600

    - name: Verify SSH is running
      systemd:
        name: sshd
        state: started
        enabled: yes
      when: ansible_distribution in ["Ubuntu", "Debian"]

    - name: Verify SSH is running (RHEL-based)
      systemd:
        name: sshd
        state: started
        enabled: yes
      when: ansible_distribution in ["CentOS", "Fedora"]

    - name: Verify SSH is running (openSUSE)
      systemd:
        name: sshd
        state: started
        enabled: yes
      when: ansible_distribution == "openSUSE Leap"

    - name: Verify VIM is default editor
      command: update-alternatives --display editor
      register: editor_check
      changed_when: false
      when: ansible_distribution in ["Ubuntu", "Debian"]

    - name: Verify EDITOR environment variable
      command: bash -c 'source /etc/profile && echo $EDITOR'
      register: editor_env
      changed_when: false
      when: ansible_distribution not in ["Ubuntu", "Debian"]
