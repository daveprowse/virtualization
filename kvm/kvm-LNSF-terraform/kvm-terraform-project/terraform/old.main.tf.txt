terraform {
  required_version = ">= 1.0"
  required_providers {
    libvirt = {
      source  = "dmacvicar/libvirt"
      version = "~> 0.9.1"
    }
  }
}

provider "libvirt" {
  uri = "qemu:///system"
}

# Storage pool
resource "libvirt_pool" "kvm_images" {
  name = "KVM-IMAGES"
  type = "dir"
  target = {
    path = var.kvm_images_dir
  }
}

# ========== Debian Server 13 ==========
resource "libvirt_volume" "debserver_disk" {
  name     = "debserver.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 32212254720
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.debian_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "debserver" {
  name = "debserver-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/debserver-user-data.yaml", {
    hostname      = var.debserver_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.debserver_hostname}
    local-hostname: ${var.debserver_hostname}
  EOF
}

resource "libvirt_domain" "debserver" {
  name   = var.debserver_hostname
  type   = "qemu"
  memory = 4096
  vcpu   = 2
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.debserver_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.debserver.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.debserver_ip, prefix = 24 }]
        }
      }
    ]
  }
}

# ========== Debian Client 13 ==========
resource "libvirt_volume" "debclient_disk" {
  name     = "debclient.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 42949672960
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.debian_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "debclient" {
  name = "debclient-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/debclient-user-data.yaml", {
    hostname      = var.debclient_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.debclient_hostname}
    local-hostname: ${var.debclient_hostname}
  EOF
}

resource "libvirt_domain" "debclient" {
  name   = var.debclient_hostname
  type   = "qemu"
  memory = 8192
  vcpu   = 4
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.debclient_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.debclient.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.debclient_ip, prefix = 24 }]
        }
      }
    ]
  }
}

# ========== Ubuntu Server 24.04 ==========
resource "libvirt_volume" "ubuntu_disk" {
  name     = "ubuntu-server.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 32212254720
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.ubuntu_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "ubuntu_server" {
  name = "ubuntu-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/ubuntu-server-user-data.yaml", {
    hostname      = var.ubuntu_server_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.ubuntu_server_hostname}
    local-hostname: ${var.ubuntu_server_hostname}
  EOF
}

resource "libvirt_domain" "ubuntu_server" {
  name   = var.ubuntu_server_hostname
  type   = "qemu"
  memory = 4096
  vcpu   = 2
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.ubuntu_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.ubuntu_server.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.ubuntu_server_ip, prefix = 24 }]
        }
      }
    ]
  }
}

# ========== CentOS Stream 10 ==========
resource "libvirt_volume" "centos_disk" {
  name     = "centos-server.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 32212254720
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.centos_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "centos_server" {
  name = "centos-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/centos-server-user-data.yaml", {
    hostname      = var.centos_server_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.centos_server_hostname}
    local-hostname: ${var.centos_server_hostname}
  EOF
}

resource "libvirt_domain" "centos_server" {
  name   = var.centos_server_hostname
  type   = "qemu"
  memory = 4096
  vcpu   = 2
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.centos_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.centos_server.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.centos_server_ip, prefix = 24 }]
        }
      }
    ]
  }
}

# ========== Fedora 43 Workstation ==========
resource "libvirt_volume" "fedora_disk" {
  name     = "fedora-client.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 42949672960
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.fedora_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "fedora_client" {
  name = "fedora-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/fedora-client-user-data.yaml", {
    hostname      = var.fedora_client_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.fedora_client_hostname}
    local-hostname: ${var.fedora_client_hostname}
  EOF
}

resource "libvirt_domain" "fedora_client" {
  name   = var.fedora_client_hostname
  type   = "qemu"
  memory = 8192
  vcpu   = 4
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.fedora_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.fedora_client.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.fedora_client_ip, prefix = 24 }]
        }
      }
    ]
  }
}

# ========== OpenSUSE 15 ==========
resource "libvirt_volume" "opensuse_disk" {
  name     = "opensuse.qcow2"
  pool     = libvirt_pool.kvm_images.name
  capacity = 32212254720
  backing_store = {
    path   = "${var.kvm_images_dir}/${var.opensuse_image_name}"
    format = { type = "qcow2" }
  }
}

resource "libvirt_cloudinit_disk" "opensuse" {
  name = "opensuse-cloudinit.iso"
  
  user_data = templatefile("${path.module}/../cloud-init/opensuse-user-data.yaml", {
    hostname      = var.opensuse_hostname
    root_password = var.root_password
    user_password = var.user_password
    ssh_key       = var.ssh_public_key
  })
  
  meta_data = <<-EOF
    instance-id: ${var.opensuse_hostname}
    local-hostname: ${var.opensuse_hostname}
  EOF
}

resource "libvirt_domain" "opensuse" {
  name   = var.opensuse_hostname
  type   = "qemu"
  memory = 4096
  vcpu   = 2
  
  os = {
    type = "hvm"
  }
  
  devices = {
    disks = [
      { volume = { volume = libvirt_volume.opensuse_disk.id } },
      { 
        volume = { file = libvirt_cloudinit_disk.opensuse.id }
        device = "cdrom"
      }
    ]
    interfaces = [
      {
        type = "network"
        source = { network = { name = var.network_name } }
        addresses = {
          ipv4 = [{ address = var.opensuse_ip, prefix = 24 }]
        }
      }
    ]
  }
}
