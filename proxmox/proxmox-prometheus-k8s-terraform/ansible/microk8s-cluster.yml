---
# MicroK8s Cluster Setup Playbook
# This playbook installs and configures a MicroK8s cluster

- name: Install MicroK8s on all MicroK8s nodes
  hosts: microk8s_controller:microk8s_workers
  become: yes
  gather_facts: yes
  
  vars:
    microk8s_channel: "1.34/stable"
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install snapd
      apt:
        name: snapd
        state: present

    - name: Install MicroK8s
      snap:
        name: microk8s
        classic: true
        channel: "{{ microk8s_channel }}"
      register: microk8s_install
      retries: 3  # Retry 3 times
      delay: 10   # Wait 10 seconds between retries
      until: microk8s_install is succeeded

    - name: Add user to microk8s group
      user:
        name: "{{ ansible_user }}"
        groups: microk8s
        append: yes

    - name: Reset SSH connection to apply group membership
      meta: reset_connection

    - name: Wait for MicroK8s to be ready (may take 5-10 min on small VMs)
      command: microk8s status --wait-ready
      changed_when: false
      async: 600  # 10 minute timeout
      poll: 15    # Check every 15 seconds
      register: microk8s_wait_result

    - name: Handle timeout gracefully
      debug:
        msg: "⚠️ MicroK8s taking longer than expected, but may still succeed"
      when: microk8s_wait_result.finished == 0

    - name: Create .kube directory
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'

    - name: Add kubectl aliases to .bashrc
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "{{ item }}"
        create: yes
      loop:
        - "alias kubectl='microk8s kubectl'"
        - "alias k='microk8s kubectl'"

# Configure the controller node
- name: Configure MicroK8s Controller
  hosts: microk8s_controller
  become: no
  gather_facts: yes

  tasks:
    - name: Enable MicroK8s addons
      command: "microk8s enable {{ item }}"
      loop:
        - dns
        - dashboard
        - registry
      register: addon_result
      changed_when: "'is already enabled' not in addon_result.stdout"

    - name: Wait for addons to be ready
      command: microk8s status --wait-ready
      changed_when: false

    - name: Wait for dashboard pods to be created (this may take a few minutes)
      shell: microk8s kubectl get pods -n kubernetes-dashboard 2>/dev/null | grep -q dashboard
      register: dashboard_check
      until: dashboard_check.rc == 0
      retries: 60
      delay: 5
      changed_when: false

    - name: Wait for all dashboard pods to be ready
      command: microk8s kubectl wait --timeout=300s --for=condition=Ready pods --all -n kubernetes-dashboard
      changed_when: false

    - name: Generate join token
      command: microk8s add-node --token-ttl 3600
      register: join_output
      changed_when: false

    - name: Extract join command
      set_fact:
        join_command: "{{ join_output.stdout_lines | select('match', '^microk8s join .*') | first }}"

    - name: Display join command
      debug:
        msg: "Join command: {{ join_command }}"

# Join worker1 to the cluster
- name: Join workers to cluster
  hosts: microk8s_workers[0]
  become: no
  serial: 1

  tasks:
    - name: Get join command from controller
      set_fact:
        join_command: "{{ hostvars[groups['microk8s_controller'][0]]['join_command'] }}"

    - name: Join worker to cluster
      command: "{{ join_command }}"
      register: join_result
      changed_when: "'Successfully joined' in join_result.stdout or join_result.rc == 0"
      failed_when: 
        - join_result.rc != 0
        - "'This node has already joined the cluster' not in join_result.stderr"

    - name: Wait 30 seconds for worker to initialize
      pause:
        seconds: 30

    - name: Wait for worker to be ready
      command: microk8s status --wait-ready
      changed_when: false
      retries: 5
      delay: 10
      register: worker_ready
      until: worker_ready.rc == 0
      failed_when: false

# Join worker2 to the cluster
- name: Join workers to cluster
  hosts: microk8s_workers[1]
  become: no
  serial: 1

  tasks:
    - name: Get join command from controller
      set_fact:
        join_command: "{{ hostvars[groups['microk8s_controller'][0]]['join_command'] }}"

    - name: Join worker to cluster
      command: "{{ join_command }}"
      register: join_result
      changed_when: "'Successfully joined' in join_result.stdout or join_result.rc == 0"
      failed_when: 
        - join_result.rc != 0
        - "'This node has already joined the cluster' not in join_result.stderr"

    - name: Wait 30 seconds for worker to initialize
      pause:
        seconds: 30

    - name: Wait for worker to be ready
      command: microk8s status --wait-ready
      changed_when: false
      retries: 5
      delay: 10
      register: worker_ready
      until: worker_ready.rc == 0
      failed_when: false
      
# Verify cluster is working
- name: Verify cluster formation
  hosts: microk8s_controller
  become: no

  tasks:
    - name: Get cluster nodes
      command: microk8s kubectl get nodes
      register: nodes_output
      changed_when: false

    - name: Display cluster nodes
      debug:
        msg: "{{ nodes_output.stdout_lines }}"

    - name: Check all nodes are Ready
      shell: microk8s kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready
      register: not_ready_nodes
      failed_when: not_ready_nodes.stdout != ""
      changed_when: false

    - name: Display success message
      debug:
        msg: "✅ MicroK8s cluster is ready with {{ (groups['microk8s_controller'] | length) + (groups['microk8s_workers'] | length) }} nodes!"
